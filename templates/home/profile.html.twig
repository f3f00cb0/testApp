<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width">
    {% block stylesheets %}
        {# 'app' must match the first argument to addEntry() in webpack.config.js #}
        {{ encore_entry_link_tags('app') }}
        <!-- Renders a link tag (if your module requires any CSS)
        <link rel="stylesheet" href="/build/app.css"> -->
    {% endblock %}

    {% block javascripts %}
        {{ encore_entry_script_tags('app') }}
        <!-- Renders app.js & a webpack runtime.js file
        <script src="/build/runtime.js" defer></script>
        <script src="/build/app.js" defer></script>
        See note below about the "defer" attribute -->
    {% endblock %}
    <style>
        body {
            height: 100%;
        }
        .section {
            padding: unset;
        }
    </style>
</head>
<body>
{{ include('header.html.twig') }}
<div class="container is-fluid">
    <section id="header">
        <div id="menu" class="text-right">
            <a href="/users/songs">Ajouter de la musique</a>
        </div>
    </section>
</div>

<section class="section" id="listsApp">
    <div class="container is-fluid">
        <div class="columns is-mobile">
            <div class="column is-12">
                {% for key in user_songs %}
                    <li class="song" data-music="yes" onclick="readSong('/userssongs/{{ user_id }}/{{ key.song }}')">{{ key.songname }}</li>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<div id="controlsApp">
    <div class="container is-fluid">
        <div class="columns is-mobile controlscolumns">
            <div class="column is-12">
                <p id="playingnow"></p>
                <audio preload="auto" id="audio" controls>
                    <source id="audiosource" src="">
                </audio>
                <div class="columns is-mobile" id="controls">
                    <div class="column is-12">
                        <div id="timeline">
                            <div id="playhead"></div>
                        </div>
                    </div>
                </div>
                {{ include('controls.html.twig') }}
                {{ include('footer.html.twig') }}
            </div>
        </div>
    </div>
</div>


<script>
    const musics = [];
    const songsname = [];
    {% for key in user_songs %}
    musics.push('/userssongs/{{ user_id }}/{{ key.song }}');
    {% endfor %}
    {% for key in user_songs %}
    songsname.push('{{ key.songname }}');
    {% endfor %}
    const songs = document.getElementsByClassName('song');
    // How Many Songs In Playlist
    let HMSIP = musics.length - 1;
    const audio = document.getElementById('audio');
    let duration = audio.duration;
    const source = document.getElementById('audiosource');
    let actualyPlaying = 0;
    const playingNow = document.getElementById('playingnow');
    // Music Playing In Playlist
    let MPIP = 0;
    source.src = musics[MPIP];
    audio.load();
    actualyPlaying = songsname[MPIP];
     if(actualyPlaying === undefined){
        playingNow.innerText = 'Aucune musique dans la liste';
    } else {
        playingNow.innerText = actualyPlaying;
    }
    let repeat = false;
    let repeatButton = document.getElementById('repeatbutton');
    let repeatButtonTop = document.getElementById('repeatButtonTop');
    let repeatButtonBottom = document.getElementById('repeatButtonBottom');

    let shuffle = false;
    let shuffleButton = document.getElementById('shufflebutton');
    let shuffleButton1 = document.getElementById('shufflebuttonp1');
    let shuffleButton2 = document.getElementById('shufflebuttonp2');
    let shuffleButton3 = document.getElementById('shufflebuttonp3');

    function toggleShuffle(){
        console.log('shuffle', shuffle);
        if (shuffle) {
            shuffleButton1.style = 'fill: #cb9d06;';
            shuffleButton2.style = 'fill: #cb9d06;';
            shuffleButton3.style = 'fill: #cb9d06;';
        } else {
            shuffleButton1.style = 'fill: green;';
            shuffleButton2.style = 'fill: green;';
            shuffleButton3.style = 'fill: green;';
        }
        shuffle = !shuffle;
    }

    function toggleRepeat() {
        console.log('repeat', repeat);
        if (repeat) {
            repeatButtonTop.style = 'fill: #cb9d06;';
            repeatButtonBottom.style = 'fill: #cb9d06;';
        } else {
            repeatButtonTop.style = 'fill: green;';
            repeatButtonBottom.style = 'fill: green;';
        }
        repeat = !repeat;
        audio.loop = !audio.loop;
    }

    function readSong(song) {
        for (let i = 0; i < musics.length; i++) {
            if (song === musics[i]) {
                MPIP = i;
                source.src = musics[i];
                audio.load();
                actualyPlaying = musics[i];
                 
                playingNow.innerText = actualyPlaying;
                
                togglePlayPause();
            }
        }
    }

    function togglePlayPause() {
        if (audio.paused || audio.ended) {
            audio.play();
            document.getElementById('playbutton').style.display = "none";
            document.getElementById('pausebutton').style.display = "block";
        } else {
            audio.pause();
            document.getElementById('playbutton').style.display = "block";
            document.getElementById('pausebutton').style.display = "none";

        }
    }

    function backward() {
        let previousSong = MPIP - 1;
        if (previousSong < 0) {
            console.log(musics[HMSIP]);
            actualyPlaying = songsname[HMSIP];
            source.src = musics[HMSIP];

            //SET CLASS PAYING TO SONG
            let playingNow = songs[HMSIP];

            //remove all playing class
            let songsInList = document.getElementsByClassName('cardplaying');
            if (songsInList[0]){
                songsInList[0].classList.remove('cardplaying');
            }
            playingNow.classList.add('cardplaying');
            audio.load();
            audio.play();
            MPIP = HMSIP;
        } else {
            console.log(musics[previousSong]);
            actualyPlaying = songsname[previousSong];
            source.src = musics[previousSong];

            //SET CLASS PAYING TO SONG
            let playingNow = songs[previousSong];

            //remove all playing class
            let songsInList = document.getElementsByClassName('cardplaying');
            if (songsInList[0]){
                songsInList[0].classList.remove('cardplaying');
            }
            playingNow.classList.add('cardplaying');
            audio.load();
            audio.play();
            MPIP = MPIP - 1;
        }
        console.log('backward');
        playingNow.innerText = actualyPlaying;
    }

    function forward() {
        let nextSong = MPIP + 1;
        if (nextSong > HMSIP) {
            actualyPlaying = songsname[0];
            source.src = musics[0];

            //SET CLASS PAYING TO SONG
            let playingNow = songs[0];

            //remove all playing class
            let songsInList = document.getElementsByClassName('cardplaying');
            songsInList[0].classList.remove('cardplaying');
            playingNow.classList.add('cardplaying');

            audio.load();
            audio.play();
            MPIP = 0;
        } else {
            actualyPlaying = songsname[nextSong];
            source.src = musics[nextSong];

            //SET CLASS PAYING TO SONG
            let playingNow = songs[nextSong];

            //remove all playing class
            let songsInList = document.getElementsByClassName('cardplaying');
            songsInList[0].classList.remove('cardplaying');
            playingNow.classList.add('cardplaying');

            audio.load();
            audio.play();
            MPIP = MPIP + 1;
        }
        console.log('forward');
        playingNow.innerText = actualyPlaying;
    }

    const timeline = document.getElementById('timeline');
    const playhead = document.getElementById("playhead");
    let timelineWidth = timeline.offsetWidth - playhead.offsetWidth;
    audio.addEventListener("timeupdate", timeUpdate, false);

    timeline.addEventListener("click", function (event) {
        moveplayhead(event);
        audio.currentTime = duration * clickPercent(event);
    }, false);

    function timeUpdate() {
        let playPercent = timelineWidth * (audio.currentTime / duration);
        playhead.style.marginLeft = playPercent + "px";
    }

    function clickPercent(event) {
        return (event.clientX - getPosition(timeline)) / timelineWidth;
    }

    playhead.addEventListener('mousedown', mouseDown, false);
    window.addEventListener('mouseup', mouseUp, false);

    let onplayhead = false;

    function mouseDown() {
        onplayhead = true;
        window.addEventListener('mousemove', moveplayhead, true);
        audio.removeEventListener('timeupdate', timeUpdate, false);
    }

    function mouseUp(event) {
        if (onplayhead === true) {
            moveplayhead(event);
            window.removeEventListener('mousemove', moveplayhead, true);
            // change current time
            audio.currentTime = duration * clickPercent(event);
            audio.addEventListener('timeupdate', timeUpdate, false);
        }
        onplayhead = false;
    }

    function moveplayhead(event) {
        let newMargLeft = event.clientX - getPosition(timeline);

        if (newMargLeft >= 0 && newMargLeft <= timelineWidth) {
            playhead.style.marginLeft = newMargLeft + "px";
        }
        if (newMargLeft < 0) {
            playhead.style.marginLeft = "0px";
        }
        if (newMargLeft > timelineWidth) {
            playhead.style.marginLeft = timelineWidth + "px";
        }
    }

    audio.onended = function () {
        forward();
    };

    function getPosition(el) {
        return el.getBoundingClientRect().left;
    }

    audio.addEventListener("canplaythrough", function () {
        duration = audio.duration;
    }, false);

    document.addEventListener('click', function (e) {
        e = e || window.event;
        const target = e.target || e.srcElement;
        console.log(target);
        let isMusic = false;
        if (target.dataset.music) {
            isMusic = target.dataset.music;
            target.classList.add('cardplaying');
            //remove all playing class
            let songsInList = document.getElementsByClassName('cardplaying');
            if (target === songsInList[0]) {
                if (songsInList[1]) {
                    if (songsInList[1].classList.contains('cardplaying')) {
                        songsInList[1].classList.remove('cardplaying');
                    }
                }
            } else {
                if (songsInList[0].classList.contains('cardplaying')) {
                    songsInList[0].classList.remove('cardplaying');
                }
            }
            target.classList.add('cardplaying');
        }
    }, false);

</script>
</body>
</html>
